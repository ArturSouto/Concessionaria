<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Consultas - Concessionária</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #121212;
            color: #e9eef8;
            font-family: Inter, Arial, sans-serif;
            padding: 24px;
        }
        h1 { color: #4da3ff; margin-bottom: 18px; }
        .card { background: #1f1f1f; border: 1px solid #0033ff; }
        table { background: transparent; }
        th { background: #0077ff; color: #fff; }
        td, th { vertical-align: middle; }
        .small-note { color: #9aa7bd; font-size: 0.9rem; }
        .spinner { width: 1rem; height: 1rem; border-width: .18rem; }
        .error { color: #ff6b6b; }
        .card strong {
            color: #4da3ff;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Resultados das Consultas</h1>

    <div class="row g-3">

        <div class="col-12 col-lg-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Clientes</strong>
                    <div>
                        <button id="btnClientes" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingClientes" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errClientes" class="error mb-2" style="display:none"></div>
                <div style="max-height: 320px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblClientes">
                        <thead><tr><th>Nome</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Veículos (Modelos)</strong>
                    <div>
                        <button id="btnVeiculos" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingVeiculos" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errVeiculos" class="error mb-2" style="display:none"></div>
                <div style="max-height: 320px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblVeiculos">
                        <thead><tr><th>Modelo</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Compradores e Veículos</strong>
                    <div>
                        <button id="btnCompradores" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingCompradores" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errCompradores" class="error mb-2" style="display:none"></div>
                <div style="max-height: 360px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblCompradores">
                        <thead><tr><th>Nome</th><th>Modelo</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Média Salarial</strong>
                    <div>
                        <button id="btnMedia" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingMedia" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errMedia" class="error mb-2" style="display:none"></div>
                <div>
                    <p class="fs-4" style="color:lightblue" id="valorMedia">Carregando...</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Clientes sem Compras</strong>
                    <div>
                        <button id="btnAntiJoin" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingAntiJoin" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errAntiJoin" class="error mb-2" style="display:none"></div>
                <div style="max-height: 320px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblAntiJoin">
                        <thead><tr><th>CPF</th><th>Nome</th><th>Idade</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Fornecedores e Vendas (Outer Join)</strong>
                    <div>
                        <button id="btnOuterJoin" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingOuterJoin" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errOuterJoin" class="error mb-2" style="display:none"></div>
                <div style="max-height: 360px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblOuterJoin">
                        <thead>
                        <tr><th>CNPJ</th><th>Fornecedor</th><th>ID Venda</th><th>ID Veículo</th><th>Data Venda</th><th>Valor</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Veículos Acima da Média</strong>
                    <div>
                        <button id="btnVeiculosMedia" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingVeiculosMedia" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errVeiculosMedia" class="error mb-2" style="display:none"></div>
                <div style="max-height: 320px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblVeiculosMedia">
                        <thead><tr><th>ID</th><th>Modelo</th><th>Combustível</th><th>Preço</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Fornecedores Acima da Média</strong>
                    <div>
                        <button id="btnFornecedoresMedia" class="btn btn-sm btn-primary">Atualizar</button>
                        <span id="loadingFornecedoresMedia" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errFornecedoresMedia" class="error mb-2" style="display:none"></div>
                <div style="max-height: 320px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblFornecedoresMedia">
                        <thead><tr><th>CNPJ</th><th>Nome</th><th>Total Vendido</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Venda Detalhada (View)</strong>
                    <div>
                        <button id="btnVendaDetalhada" class="btn btn-sm btn-info">Atualizar</button>
                        <span id="loadingVendaDetalhada" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errVendaDetalhada" class="error mb-2" style="display:none"></div>
                <div style="max-height: 400px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblVendaDetalhada">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Manutenção Completa (View)</strong>
                    <div>
                        <button id="btnManutencao" class="btn btn-sm btn-info">Atualizar</button>
                        <span id="loadingManutencao" class="spinner-border spinner small spinner-border-sm" style="display:none"></span>
                    </div>
                </div>
                <div id="errManutencao" class="error mb-2" style="display:none"></div>
                <div style="max-height: 400px; overflow:auto;">
                    <table class="table table-sm text-light" id="tblManutencao">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const base = "";

    function showSpinner(id, show) {
        document.getElementById(id).style.display = show ? "inline-block" : "none";
    }
    function showError(id, msg) {
        const el = document.getElementById(id);
        if (!msg) el.style.display = "none";
        else { el.style.display = "block"; el.textContent = msg; }
    }
    function escapeHtml(str) {
        return (str || "").toString().replace(/[&<>"'`=\/]/g, s => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
            "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
        })[s]);
    }

    async function fetchDynamicView(url, tblId, errId, spinnerId) {
        const tbl = document.getElementById(tblId);
        const thead = tbl.querySelector("thead");
        const tbody = tbl.querySelector("tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";
        showError(errId, "");
        showSpinner(spinnerId, true);

        try {
            const res = await fetch(base + url);
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();
            if (data.length === 0) {
                thead.innerHTML = "<tr><th>Nenhum registro encontrado</th></tr>";
                return;
            }

            const cols = Object.keys(data[0]);
            thead.innerHTML = "<tr>" + cols.map(c => `<th>${escapeHtml(c)}</th>`).join("") + "</tr>";

            data.forEach(row => {
                const line = cols.map(c => `<td>${escapeHtml(row[c])}</td>`).join("");
                tbody.insertAdjacentHTML("beforeend", `<tr>${line}</tr>`);
            });
        } catch (err) {
            showError(errId, "Erro: " + err.message);
        } finally {
            showSpinner(spinnerId, false);
        }
    }

    async function fetchTable(url, tblId, errId, spinnerId, rowFn) {
        const tbl = document.querySelector(`#${tblId} tbody`);
        tbl.innerHTML = "";
        showError(errId, "");
        showSpinner(spinnerId, true);
        try {
            const res = await fetch(base + url);
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();
            data.forEach(row => tbl.insertAdjacentHTML("beforeend", rowFn(row)));
        } catch (err) {
            showError(errId, "Erro: " + err.message);
        } finally { showSpinner(spinnerId, false); }
    }

    document.getElementById("btnClientes").onclick = () => fetchTable("/consultas/clientes", "tblClientes", "errClientes", "loadingClientes", r => `<tr><td>${escapeHtml(r)}</td></tr>`);
    document.getElementById("btnVeiculos").onclick = () => fetchTable("/consultas/veiculos", "tblVeiculos", "errVeiculos", "loadingVeiculos", r => `<tr><td>${escapeHtml(r)}</td></tr>`);
    document.getElementById("btnCompradores").onclick = () => fetchTable("/consultas/compradores", "tblCompradores", "errCompradores", "loadingCompradores", r => `<tr><td>${escapeHtml(r.nome || '')}</td><td>${escapeHtml(r.modelo || '')}</td></tr>`);
    document.getElementById("btnMedia").onclick = carregarMedia;
    document.getElementById("btnAntiJoin").onclick = () => fetchTable("/consultas/clientes-sem-compras", "tblAntiJoin", "errAntiJoin", "loadingAntiJoin", r => `<tr><td>${r.cpf}</td><td>${escapeHtml(r.nome)}</td><td>${r.idade}</td></tr>`);
    document.getElementById("btnOuterJoin").onclick = () => fetchTable("/consultas/fornecedores-vendas", "tblOuterJoin", "errOuterJoin", "loadingOuterJoin", r => `<tr><td>${r.fornecedor_cnpj || ''}</td><td>${escapeHtml(r.fornecedor_nome || '')}</td><td>${r.idvenda || ''}</td><td>${r.veiculo_id || ''}</td><td>${r.data_venda || ''}</td><td>${r.valor_venda || ''}</td></tr>`);
    document.getElementById("btnVeiculosMedia").onclick = () => fetchTable("/consultas/veiculos-acima-media", "tblVeiculosMedia", "errVeiculosMedia", "loadingVeiculosMedia", r => `<tr><td>${r.id}</td><td>${escapeHtml(r.modelo)}</td><td>${escapeHtml(r.combustivel)}</td><td>${r.preco}</td></tr>`);
    document.getElementById("btnFornecedoresMedia").onclick = () => fetchTable("/consultas/fornecedores-acima-media", "tblFornecedoresMedia", "errFornecedoresMedia", "loadingFornecedoresMedia", r => `<tr><td>${r.CNPJ}</td><td>${escapeHtml(r.Nome)}</td><td>${r.total_vendido}</td></tr>`);

    document.getElementById("btnVendaDetalhada").onclick = () => fetchDynamicView("/consultas/venda-detalhada", "tblVendaDetalhada", "errVendaDetalhada", "loadingVendaDetalhada");
    document.getElementById("btnManutencao").onclick = () => fetchDynamicView("/consultas/manutencao-completa", "tblManutencao", "errManutencao", "loadingManutencao");

    async function carregarMedia() {
        const out = document.getElementById("valorMedia");
        showSpinner("loadingMedia", true);
        try {
            const res = await fetch(base + "/consultas/media-salario");
            const data = await res.json();
            out.textContent = "R$ " + Number(data).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        } catch { out.textContent = "Erro"; }
        finally { showSpinner("loadingMedia", false); }
    }

    window.onload = () => {
        document.getElementById("btnClientes").click();
        document.getElementById("btnVeiculos").click();
        document.getElementById("btnCompradores").click();
        document.getElementById("btnMedia").click();
        document.getElementById("btnAntiJoin").click();
        document.getElementById("btnOuterJoin").click();
        document.getElementById("btnVeiculosMedia").click();
        document.getElementById("btnFornecedoresMedia").click();
        document.getElementById("btnVendaDetalhada").click();
        document.getElementById("btnManutencao").click();
    };
</script>
</body>
</html>
